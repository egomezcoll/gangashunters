!function(){"use strict";angular.module("mdr.file",[]).controller("FileCtrl",["$scope","$element","$attrs",function(e,t,n){function i(t){e.count={send:0,complete:0,invalid:0},c(t)&&s(t)&&$.each(t,function(e,t){a(e,t)}),$("#fileId_"+e.$id+" input").replaceWith($("#fileId_"+e.$id+" input").val("").clone(!0))}function a(t,n){function i(){}function a(n){if(n.lengthComputable){var i=n.loaded/n.total*100;$("#fileId_"+e.$id+" .mdr-file-dad-content .preview-"+t+" .progress .progress-bar").css("width",i+"%")}}function l(n){e.$apply(function(){e.count.complete++,e.model=c.response}),$("#fileId_"+e.$id+" .mdr-file-dad-content .preview-"+t).fadeOut("slow",function(){$(this).remove()})}function d(e){console.log("An error occurred while transferring the file.")}function s(e){console.log("The transfer has been canceled by the user.")}var c=new XMLHttpRequest;if(c.open("POST",e.url,!0),void 0!==e.headers){var p=e.headers;for(var u in p)c.setRequestHeader(u,p[u])}c.addEventListener("loadstart",i,!1),c.addEventListener("progress",a,!1),c.addEventListener("load",l,!1),c.addEventListener("error",d,!1),c.addEventListener("abort",s,!1);var f=new FormData;f.append("file",n);var v=new FileReader;v.readAsDataURL(n),v.onload=function(i){var a=o(n);r(n,t,i.target.result,a.icon,a.messages),a.resp?(e.$apply(function(){e.count.send++}),c.send(f)):(e.$apply(function(){e.count.invalid++}),c.abort())}}function r(t,n,i,a,r){var o=p(t.size),l=null;l=a?'<span class="glyphicon glyphicon-file"></span>':'<img src="'+i+'">';var d='<div class="col-xs-12 col-sm-6 col-md-4 col-lg-2 preview-'+n+'"><div class="thumbnail">'+l+'<div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="" aria-valuemin="0" aria-valuemax="100" style="width:0%"></div></div><div class="caption"><p>'+t.name+'<span class="text-muted"> / '+o+"</span></p></div></div></div>";$("#fileId_"+e.$id+" .mdr-file-dad-content").append($(d).fadeIn("slow")),void 0!==r&&r.forEach(function(t){$("#fileId_"+e.$id+" .mdr-file-dad-content .preview-"+n+" .thumbnail .caption").append('<p class="text-danger">'+t+"</p>")})}function o(e){var t=[],n=!1,i=l(e),a=d(e);return(i.icon||a.icon)&&(n=!0),i.resp||t.push(i.msg),a.resp||t.push(a.msg),i.resp&&a.resp?{resp:!0,icon:n}:{resp:!1,icon:n,messages:t}}function l(t){var n=!1;if("image/jpeg"!==t.type&&"image/png"!==t.type&&"image/svg+xml"!==t.type&&"image/gif"!==t.type&&(n=!0),void 0===e.formats)return{resp:!0,icon:n,msg:""};var i=t.name.substring(t.name.lastIndexOf(".")+1).toLowerCase(),a=e.formats;"string"==typeof a&&(a=a.split(","));for(var r=0;r<a.length;r++)if(i==a[r].trim())return{resp:!0,icon:n,msg:""};return{resp:!1,icon:n,msg:"File type "+i+" not allowed"}}function d(t){var n=!1,i=t.size;if(i>512e4&&(n=!0),void 0===e.size)return{resp:!0,icon:n};var a=1e3*e.size*1024;return a>i?{resp:!0,icon:n}:{resp:!1,icon:n,msg:"File exceeds size "+e.size+"MB"}}function s(t){return void 0===e.limit?!0:e.limit<t.length?(alert("Max files upload is "+e.limit),!1):!0}function c(e){return n.multiple&&e.length>1?(alert("One file for time"),!1):!0}function p(e){var t=["Bytes","KB","MB","GB","TB"];if(0===e)return"n/a";var n=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return 0===n?e+" "+t[n]:(e/Math.pow(1024,n)).toFixed(1)+" "+t[n]}e.text="Drag or click here",e.count={send:0,complete:0,invalid:0},t.bind("dragenter",function(e){e.stopPropagation(),e.preventDefault();var t=$(e.target).parent();t.addClass("mdr-file-dad-text-hover")}),t.bind("dragleave",function(e){e.stopPropagation(),e.preventDefault();var t=$(e.target).parent();t.removeClass("mdr-file-dad-text-hover")}),t.bind("dragover",function(e){e.stopPropagation(),e.preventDefault()}),t.bind("drop",function(e){e.stopPropagation(),e.preventDefault();var t=$(e.target).parent();t.removeClass("mdr-file-dad-text-hover");var n=e.originalEvent.dataTransfer.files;i(n)}),e.clearContent=function(){$("#fileId_"+e.$id+" .mdr-file-dad-content div").fadeOut("slow",function(){$(this).remove()}),$("#fileId_"+e.$id+" .mdr-file-dad-content button").fadeOut("slow")},e.upload=function(e){var t=e.files;i(t)},e.$watchCollection("count",function(t,n){t.send==t.complete&&t.invalid>0&&$("#fileId_"+e.$id+" .mdr-file-dad-content button").fadeIn("slow")})}]).directive("mdrFile",["$compile",function(e){var t=function(t,n,i){(void 0!==i.multiple||i.multiple)&&n.find("input").removeAttr("multiple"),i.disabled&&n.find(".mdr-file-dad").addClass("disabled"),e(n.contents())(t)};return{restrict:"E",controller:"FileCtrl",link:t,scope:{url:"@",headers:"=",model:"=",size:"=",limit:"=",formats:"=",disabled:"=",text:"@"},template:'<div class="mdr-file-dad" id="fileId_{{$id}}"><div class="mdr-file-dad-text"><h3><span class="glyphicon glyphicon-cloud-upload"></span>{{text}}</h3></div><input type="file" name="file" onchange="angular.element(this).scope().upload(this)" ng-model="model" ng-disabled="disabled" multiple><div class="row mdr-file-dad-content"><button type="button" class="close" aria-label="Close" ng-click="clearContent()"><span aria-hidden="true">&times;</span></button></div></div>'}}])}();